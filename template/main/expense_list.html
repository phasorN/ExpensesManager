{% extends 'main/base.html' %}

{% block title_block %}
	<title>Expense List</title>
{% endblock %}


{% block body_block %}
	{% if confirmed == False %}
		<p style="color: red;">Your email is not confirmed.You can only add expenses but can not view them.</p>
	{% else %}
		<script
	src="https://code.jquery.com/jquery-2.2.4.min.js"
	integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
	crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
	<script src="https://unpkg.com/jspdf-autotable@2.3.1/dist/jspdf.plugin.autotable.js"></script>
		<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
		<style type="text/css">
			table, th, td{
				border:solid black 1px;
				padding-left: 5px;
				padding-right: 5px;
			}
			td{
				width: 100%;
				font-family: monospace;
				font-size: 1.3em;
			}
			th{
				width: 70%;
				font-family: monospace;
				font-size: 1.3em;
			}
		</style>
		<script type="text/javascript">
			$(document).ready(function(){

				{% regroup expense_list by date as regrouped_expense_list %}

					{% for date, expense_data in regrouped_expense_list %}
						

						$("#{{ date|date:"U" }}").click(function(){
							$("#{{ date|date:"U" }}_div").slideToggle("slow")
						});

						var t = 0;
							{% for e in expense_data %}
								{% if forloop.counter0 == 0 %}
								{% endif %}
								t += {{ e.amount }};
							{% endfor %}
									a = "<tr><th style = 'text-align:right'>Total: </th><td><strong>Rs " + t + "</strong></td></tr>"
									$("#{{ date|date:"U" }}_table").append(a)
						{% if forloop.counter0 == 0 %}
						$("#{{ date|date:"U" }}_div").slideToggle("slow")
						{% endif %}
						
					{% endfor %}
				})
		</script>

	    <script type="text/javascript">
			function generate(x) {

			// console.log(x);
			i = x.indexOf("+");
			len = x.length;
			// console.log(i + ", " + len);

			xI = x.slice(0, i)
			s = x.slice(i+1, len)

			console.log(xI);
			console.log(s);

			id = xI + "_table"
			
			var doc = new jsPDF('p', 'pt');
			var res = doc.autoTableHtmlToJson(document.getElementById(id));
			// console.log(res);
			
			var header = function(data) {
				doc.setFontSize(18);
				doc.setTextColor(40);
				doc.setFontStyle('normal');
				doc.text("Expenses Report for " + s , data.settings.margin.left, 50);
			};

			var options = {
				theme: 'grid', 
				addPageContent: header,
				// margin: { top: 80 },
				startY: 70,

				//WRAP CELLS ACCORDING TO TEST LENGTH.
				// styles: {overflow: 'hidden', columnWidth: 'wrap'},
				// columnStyles: {text: {columnWidth: 'auto'}}
			};

			doc.autoTable(res.columns, res.data, options);

			doc.save("ExpensesList-" + s + ".pdf");
		}
	    </script>

		<div class="jumbotron" >
			<form action="{% url 'main:search' %}" method="GET">
				<div class="input-group input-group-sm mb-3">
					<input type="text" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm" name="query">
					<!-- <div class="input-group-append"> -->
						<input type = "submit" class=" btn input-group-text" style="background-color: rgba(21, 21, 21, 0.3)" id="inputGroup-sizing-sm" value = "Search">
					<!-- </div> -->
				</div>
			</form>
			<h3>List of all expenses:</h3>
				{% for date, expense_data in regrouped_expense_list %}
				<div class="dropdown">
					<!-- <p> -->
					<button id="{{ date|date:"U" }}" class="btn btn-block dropdown-toggle" style=" background-color: rgb(210, 210, 210);  color: black;">{{ date }}</button>
						<div id="{{ date|date:"U" }}_div" style="display: none; width: 100%; overflow-x: auto;">
							<table id="{{ date|date:"U" }}_table" style="width: 100%">
								<tr style="color: green;">
									<th>Title</th>
									<td>Amount</td>
								</tr>
							{% for e in expense_data %}
								<tr>
									<th>{{ e.title }}</th>
									<td>Rs {{ e.amount }}</td>
								</tr>
							{% endfor %}
							</table>
							<button id = "{{ date|date:"U" }}+{{ date|date:"d-F-Y" }}" class="btn btn-primary" onClick ="generate(this.id)">Download PDF</button>
						</div>
					<!-- </p> -->
				</div>
				<br>
				{% empty %}
					<p>No expenses yet!</p>
					<p>Click <a href="{% url 'main:add_expense' %}">here</a> to add a new expense.</p>
				{% endfor %}
		</div>
	{% endif %}
{% endblock %}