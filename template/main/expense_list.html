{% extends 'main/base.html' %}

{% block title_block %}
	<title>Expense List</title>
{% endblock %}


{% block body_block %}
	{% if confirmed == False %}
		<p style="color: red;">Your email is not confirmed.You can only add expenses but can not view them.</p>
	{% else %}
		<script
	src="https://code.jquery.com/jquery-2.2.4.min.js"
	integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
	crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
	<script src="https://unpkg.com/jspdf-autotable@2.3.1/dist/jspdf.plugin.autotable.js"></script>
		<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
		<style type="text/css">
			table, th, td{
				border:solid black 1px;
				padding-left: 5px;
				padding-right: 5px;
			}
			td{
				width: 100%;
			}
			th{
				width: 70%;
			}
		</style>
		<script type="text/javascript">
			$(document).ready(function(){

				{% regroup expense_list by date as regrouped_expense_list %}

					{% for date, expense_data in regrouped_expense_list %}
						

						$("#{{ date|date:"U" }}").click(function(){
							$("#{{ date|date:"U" }}_div").slideToggle("slow")
						});

						var t = 0;
							{% for e in expense_data %}
								{% if forloop.counter0 == 0 %}
								{% endif %}
								t += {{ e.amount }};
							{% endfor %}
									a = "<tr><th style = 'text-align:right'>Total: </th><td><strong>Rs " + t + "</strong></td></tr>"
									$("#{{ date|date:"U" }}_table").append(a)
						{% if forloop.counter0 == 0 %}
						$("#{{ date|date:"U" }}_div").slideToggle("slow")
						{% endif %}
						
					{% endfor %}
				})
		</script>

		<!-- PDF creation Script using jsPDF-autoTable-plugin -->
	    <script type="text/javascript">
			function generate() {

				var month_names = new Array("January", "February", "March", 
				"April", "May", "June", "July", "August", "September", 
				"October", "November", "December");

				tableObjects = document.getElementsByTagName('table');

				var tableIdArray = []
				var previousY = 0
				var doc = new jsPDF('p', 'pt');

				//Creating array of table ID's.
				for (var i = 0 ; i < tableObjects.length ; i++)
				{
					xx = i+1
					indexOfUnderscore = tableObjects[i].id.indexOf("_");
					tableIdArray[i] = tableObjects[i].id.toString().slice(0, indexOfUnderscore);

					//Required in JavaScript
					s = tableIdArray[i] + "000";
					x = tableIdArray[i];

					//Getting date from unixEpoh
					date = new Date(parseInt(s))
					s = date.getDate().toString() + "-" + month_names[date.getMonth()] + "-" + date.getFullYear()

					if (i == 0)
					{
						endDate = s;
					}

					if(i == tableObjects.length - 1)
					{
						startDate = s;
					}
				}

				doc.setFontSize(12);
				doc.setTextColor(40);

				d = new Date()
				userDetails = " Downloaded by {{ user.first_name }} {{ user.last_name }} on " + d.getDate().toString() + "-" + month_names[d.getMonth()] + "-" + d.getFullYear() + " at " + d.toLocaleTimeString()

				doc.text(userDetails , 40, 30);


				doc.setFontSize(17);
				doc.setTextColor(40);
				message = "Expenses Report from " + startDate + " to " + endDate
				doc.text(message , 40, 55);


				for (var i = 0 ; i < tableObjects.length ; i++)
				{
					doc.setFontSize(5);
					//Required in JavaScript
					s = tableIdArray[i] + "000";
					x = tableIdArray[i];

					//Getting date from unixEpoh
					date = new Date(parseInt(s))
					s = date.getDate().toString() + "-" + month_names[date.getMonth()] + "-" + date.getFullYear()

					id = x + "_table"

					pageNumberBeforeTablePrinting = doc.internal.getCurrentPageInfo().pageNumber


					var header = function(data) {
						doc.setFontSize(13);
						doc.setTextColor(40);
						doc.setFontStyle('normal');

						if (i == 0){
							doc.text(s , data.settings.margin.left, previousY + 80);
						}

						else{
							if(doc.internal.getCurrentPageInfo().pageNumber != pageNumberBeforeTablePrinting)
							{
								previousY = 0
								doc.text(s , data.settings.margin.left, previousY + 50);
							}
							else
							{
								doc.text(s , data.settings.margin.left, previousY + 50);
							}
						}
					};



					var options = {
						theme: 'grid', 

						//Auto paggination makes header text print twice on the same and the following page.
						margin: { top: 60 },
						
						//startY overrides margin top, startY is used when auto paggination does not occur.
						startY: previousY + 60,
						pageBreak: "avoid",

						addPageContent: header,
						//WRAP CELLS ACCORDING TO TEST LENGTH.
						// styles: {overflow: 'hidden', columnWidth: 'wrap'},
						// columnStyles: {text: {columnWidth: 'auto'}}

						drawCell: function(cell, data) {
							var rows = data.table.rows;
							if (data.row.index == rows.length - 1) {
								doc.setTextColor("green");
								doc.setFillColor(220, 220, 220);
							}
						}
					};

					if (i == 0)
					{
						options.startY = previousY + 90;
					}
					
					var res = doc.autoTableHtmlToJson(document.getElementById(id));

					doc.autoTable(res.columns, res.data, options);

					previousY = doc.autoTable.previous.finalY;
				}
				doc.save("ExpensesList_" + startDate + "_to_" + endDate + ".pdf");
			}
	    </script>
			{% if expense_list %}

			<!-- TODO -->
			{# {% if messages %} #}
				<!-- <div class="messages">
					<div class="alert alert-success alert-dismissable alert-link">
						<button class="close" type="button" data-dismiss="alert" aria-hidden="true">Ã—</button>
						z
					</div>
				</div> -->
			{# {% endif %} #}

			{% if user.is_staff %}
				<!-- <p style="margin-left: 0"> > Click on any expense to get its details.</p> -->
			{% else %}
				<br>
			{% endif %}

			<!-- Uncomment to get PDF functionality -->
			<!-- <button class="container-fluid btn btn-primary" style="height: 30px; padding: 0" onClick ="generate()">Download list as PDF</button> -->

			<!-- <hr> -->

			<p style="font-size: 20px">Expense List</p>

			<form action="{% url 'main:search' %}" method="GET">
				<div class="input-group input-group-sm mb-3">
					<input type="text" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm" name="query" required>
					<!-- <div class="input-group-append"> -->
						<input type = "submit" class=" btn input-group-text" style="background-color: rgba(21, 21, 21, 0.3)" id="inputGroup-sizing-sm" value = "Search">
					<!-- </div> -->
				</div>
			</form>
			{% endif %}

			<p style = "font-size: 17px">
				{% if grand_total and grand_total != 0 %}
				GrandTotal is <strong> Rs {{ grand_total }} </strong>
				{% else %}
				{% endif %}
			</p>
				{% for date, expense_data in regrouped_expense_list %}
				<div class="dropdown">
					<!-- <p> -->
					<button id="{{ date|date:"U" }}" class="btn btn-block dropdown-toggle" style=" background-color: rgb(210, 210, 210);  color: black;">{{ date }}</button>
						<div id="{{ date|date:"U" }}_div" style="display: none; width: 100%; overflow-x: auto;">
							<table id="{{ date|date:"U" }}_table" style="width: 100%">
								<tr style="color: green;">
									<th>Title</th>
									<td>Amount</td>
								</tr>
							{% for e in expense_data %}
								<tr>
									{% if user.is_staff %}
									<th><a href="{% url "main:expense_detail" pk=e.pk %}" style="color: blue; text-decoration: ">{{ e.title }}</a>
										{% if e.description %}
											<ul>
												<li>{{ e.description }}</li>
											</ul>
										{% endif %}
									</th>
									{% else %}
										<th>{{ e.title }}
											{% if e.description %}
											<ul>
												<li>{{ e.description }}</li>
											</ul>
											{% endif %}
										</th>
									{% endif %}
									<td>Rs {{ e.amount }}</td>
								</tr>
							{% endfor %}
							</table>
						</div>
					<!-- </p> -->
				</div>
				<br>
				{% empty %}
					<p>No expenses yet!</p>
					<p>Click <a href="{% url 'main:add_expense' %}">here</a> to add a new expense.</p>
				{% endfor %}
	{% endif %}
{% endblock %}